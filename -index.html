<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodoMaster - Ïä§ÎßàÌä∏ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏</title>
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úÖ</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .task-complete {
            animation: completeWave 0.4s ease-out;
        }
        @keyframes completeWave {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); background-color: #dcfce7; }
            100% { transform: scale(1); }
        }
        
        .glassmorphism {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            will-change: transform, box-shadow;
        }
        .card-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .sidebar {
            width: 320px;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            border-right: 1px solid rgba(226, 232, 240, 0.8);
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .main-content {
            margin-left: 320px;
            min-height: 100vh;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .floating-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 20;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .category-active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }
        
        .progress-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        @media (max-width: 768px) {
            .sidebar { 
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar.mobile-open { 
                transform: translateX(0);
            }
            .main-content { 
                margin-left: 0; 
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // =============== Utility Helpers ===============
        const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
        const fmtDate = (iso) => (iso ? new Date(iso).toLocaleDateString('ko-KR') : "");
        const todayISO = () => new Date().toISOString().slice(0, 10);

        const PRIORITIES = [
            { value: "none", label: "ÏóÜÏùå", color: "gray" },
            { value: "low", label: "ÎÇÆÏùå", color: "blue" },
            { value: "medium", label: "Î≥¥ÌÜµ", color: "yellow" },
            { value: "high", label: "ÎÜíÏùå", color: "red" },
        ];

        function cn(...args) {
            return args.filter(Boolean).join(" ");
        }

        // =============== Local File System Storage ===============
        class LocalFileDB {
            constructor() {
                this.dbFile = 'data.json';
                this.data = { categories: [], tasks: [] };
                this.loadData();
            }

            async loadData() {
                try {
                    // Try to load from localStorage first (fallback)
                    const stored = localStorage.getItem('checklistApp');
                    if (stored) {
                        this.data = JSON.parse(stored);
                    }
                    
                    // Initialize default categories if empty
                    if (this.data.categories.length === 0) {
                        this.data.categories = [
                            { id: "work", name: "ÏóÖÎ¨¥", emoji: "üíº", builtin: false },
                            { id: "home", name: "Í∞ÄÏ†ï", emoji: "üè†", builtin: false },
                            { id: "personal", name: "Í∞úÏù∏", emoji: "üë§", builtin: false },
                            { id: "study", name: "ÌïôÏäµ", emoji: "üìö", builtin: false }
                        ];
                        await this.saveData();
                    }
                } catch (e) {
                    console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', e);
                }
            }

            async saveData() {
                try {
                    // Save to localStorage
                    localStorage.setItem('checklistApp', JSON.stringify(this.data));
                    
                    // Also create downloadable JSON file
                    this.createDownloadableBackup();
                } catch (e) {
                    console.error('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïò§Î•ò:', e);
                }
            }

            createDownloadableBackup() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Create invisible download link
                const link = document.createElement('a');
                link.href = url;
                link.download = 'checklist-backup.json';
                link.style.display = 'none';
                document.body.appendChild(link);
                
                // Auto-download on first save (optional)
                // link.click();
                
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            async getCategories() {
                return [...this.data.categories];
            }

            async getTasks() {
                return [...this.data.tasks];
            }

            async saveCategory(category) {
                const index = this.data.categories.findIndex(c => c.id === category.id);
                if (index >= 0) {
                    this.data.categories[index] = category;
                } else {
                    this.data.categories.push(category);
                }
                await this.saveData();
            }

            async deleteCategory(id) {
                this.data.categories = this.data.categories.filter(c => c.id !== id);
                // Also remove tasks from this category
                this.data.tasks = this.data.tasks.filter(t => t.categoryId !== id);
                await this.saveData();
            }

            async saveTask(task) {
                const index = this.data.tasks.findIndex(t => t.id === task.id);
                if (index >= 0) {
                    this.data.tasks[index] = task;
                } else {
                    this.data.tasks.push(task);
                }
                await this.saveData();
            }

            async deleteTask(id) {
                this.data.tasks = this.data.tasks.filter(t => t.id !== id);
                await this.saveData();
            }

            async exportData() {
                return JSON.stringify(this.data, null, 2);
            }

            async importData(jsonStr) {
                try {
                    const newData = JSON.parse(jsonStr);
                    this.data = newData;
                    await this.saveData();
                    return true;
                } catch (e) {
                    console.error('Import Ïò§Î•ò:', e);
                    return false;
                }
            }
        }

        const db = new LocalFileDB();

        // =============== Sound Effects ===============
        function playTone(freq = 880, duration = 0.14, type = 'triangle', gain = 0.05) {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.connect(g);
                g.connect(ctx.destination);
                const now = ctx.currentTime;
                g.gain.setValueAtTime(0.0001, now);
                g.gain.exponentialRampToValueAtTime(gain, now + 0.02);
                g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
                osc.start(now);
                osc.stop(now + duration + 0.02);
                osc.onended = () => ctx.close && ctx.close();
            } catch (e) {
                console.log('Audio context not available');
            }
        }

        function playSuccess() {
            playTone(880, 0.12, 'triangle', 0.06);
            setTimeout(() => playTone(1320, 0.12, 'triangle', 0.05), 90);
        }

        function playUndo() {
            playTone(440, 0.12, 'sine', 0.05);
        }

        // =============== Main App ===============
        function App() {
            const [categories, setCategories] = useState([]);
            const [tasks, setTasks] = useState([]);
            const [selectedCat, setSelectedCat] = useState("all");
            const [query, setQuery] = useState("");
            const [debouncedQuery, setDebouncedQuery] = useState("");
            const [statusFilter, setStatusFilter] = useState("all");
            const [prioFilter, setPrioFilter] = useState("all");
            const [sortBy, setSortBy] = useState("order");
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [newCatName, setNewCatName] = useState("");
            const [soundOn, setSoundOn] = useState(true);
            const [editingCatId, setEditingCatId] = useState(null);
            const [editCatName, setEditCatName] = useState("");
            const [editCatEmoji, setEditCatEmoji] = useState("");
            const fileInputRef = useRef(null);

            // Debounce search query for performance
            useEffect(() => {
                const timer = setTimeout(() => {
                    setDebouncedQuery(query);
                }, 300);
                return () => clearTimeout(timer);
            }, [query]);

            // Load data on mount
            useEffect(() => {
                loadAllData();
            }, []);

            async function loadAllData() {
                const cats = await db.getCategories();
                const tasks = await db.getTasks();
                setCategories([{ id: "all", name: "Ï†ÑÏ≤¥", emoji: "üìã", builtin: true }, ...cats]);
                setTasks(tasks);
            }

            // Stats
            const stats = useMemo(() => {
                const filtered = selectedCat === "all" ? tasks : tasks.filter(t => t.categoryId === selectedCat);
                const completed = filtered.filter(t => t.checked).length;
                const total = filtered.length;
                return { completed, total, progress: total > 0 ? Math.round((completed / total) * 100) : 0 };
            }, [tasks, selectedCat]);

            // Filtered and sorted tasks with performance optimization
            const filteredTasks = useMemo(() => {
                let result = tasks;

                // Category filter
                if (selectedCat !== "all") {
                    result = result.filter(t => t.categoryId === selectedCat);
                }

                // Search filter with debounced query
                if (debouncedQuery.trim()) {
                    const q = debouncedQuery.toLowerCase();
                    result = result.filter(t => 
                        t.title.toLowerCase().includes(q) || 
                        (t.memo && t.memo.toLowerCase().includes(q))
                    );
                }

                // Status filter
                if (statusFilter === "completed") {
                    result = result.filter(t => t.checked);
                } else if (statusFilter === "pending") {
                    result = result.filter(t => !t.checked);
                }

                // Priority filter
                if (prioFilter !== "all") {
                    result = result.filter(t => t.priority === prioFilter);
                }

                // Sort with pinned tasks at top
                result.sort((a, b) => {
                    // Pinned tasks always come first
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    
                    if (sortBy === "priority") {
                        const prio = { none: 0, low: 1, medium: 2, high: 3 };
                        return prio[b.priority] - prio[a.priority];
                    } else if (sortBy === "due") {
                        if (!a.due && !b.due) return 0;
                        if (!a.due) return 1;
                        if (!b.due) return -1;
                        return new Date(a.due) - new Date(b.due);
                    } else if (sortBy === "name") {
                        return a.title.localeCompare(b.title);
                    }
                    return a.order - b.order; // default order
                });

                return result;
            }, [tasks, selectedCat, debouncedQuery, statusFilter, prioFilter, sortBy]);

            // Actions
            async function addCategory() {
                if (!newCatName.trim()) return;
                const cat = {
                    id: uid(),
                    name: newCatName.trim(),
                    emoji: "üìÅ",
                    builtin: false,
                };
                await db.saveCategory(cat);
                setCategories(prev => [...prev, cat]);
                setNewCatName("");
            }

            async function deleteCategory(id) {
                if (!confirm("Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨ÏôÄ Í¥ÄÎ†®Îêú Î™®Îì† ÏûëÏóÖÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
                await db.deleteCategory(id);
                setCategories(prev => prev.filter(c => c.id !== id));
                setTasks(prev => prev.filter(t => t.categoryId !== id));
                if (selectedCat === id) setSelectedCat("all");
            }

            async function renameCategory(catId, newName, newEmoji) {
                const cat = categories.find(c => c.id === catId);
                if (!cat || cat.builtin) return;
                
                const updated = { ...cat, name: newName, emoji: newEmoji };
                await db.saveCategory(updated);
                setCategories(prev => prev.map(c => c.id === catId ? updated : c));
            }

            async function addTask() {
                if (selectedCat === "all") {
                    alert("ÏûëÏóÖÏùÑ Ï∂îÍ∞ÄÌïòÎ†§Î©¥ ÌäπÏ†ï Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                    return;
                }
                const task = {
                    id: uid(),
                    title: "ÏÉà ÏûëÏóÖ",
                    checked: false,
                    priority: "none",
                    due: "",
                    memo: "",
                    categoryId: selectedCat,
                    order: tasks.length,
                    createdAt: new Date().toISOString(),
                };
                try {
                    await db.saveTask(task);
                    setTasks(prev => [...prev, task]);
                    console.log('ÏûëÏóÖ Ï∂îÍ∞Ä ÏÑ±Í≥µ:', task);
                } catch (error) {
                    console.error('ÏûëÏóÖ Ï∂îÍ∞Ä Ïã§Ìå®:', error);
                    alert('ÏûëÏóÖ Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            }

            async function updateTask(id, updates) {
                const task = tasks.find(t => t.id === id);
                if (!task) return;
                const updated = { ...task, ...updates };
                await db.saveTask(updated);
                setTasks(prev => prev.map(t => t.id === id ? updated : t));
            }

            async function togglePinTask(id) {
                const task = tasks.find(t => t.id === id);
                if (!task) return;
                await updateTask(id, { pinned: !task.pinned });
            }

            async function deleteTask(id) {
                await db.deleteTask(id);
                setTasks(prev => prev.filter(t => t.id !== id));
            }

            async function toggleTask(id) {
                const t = tasks.find(x => x.id === id);
                if (!t) return;
                const nextChecked = !t.checked;
                
                if (soundOn) {
                    if (nextChecked) playSuccess(); 
                    else playUndo();
                }
                
                // Add visual feedback
                const taskEl = document.querySelector(`[data-task-id="${id}"]`);
                if (taskEl && nextChecked) {
                    taskEl.classList.add('task-complete');
                    setTimeout(() => taskEl.classList.remove('task-complete'), 500);
                }
                
                await updateTask(id, { checked: nextChecked });
            }

            async function clearCompleted() {
                if (!confirm("ÏôÑÎ£åÎêú Î™®Îì† ÏûëÏóÖÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
                const completedIds = tasks.filter(t => t.checked).map(t => t.id);
                for (const id of completedIds) {
                    await db.deleteTask(id);
                }
                setTasks(prev => prev.filter(t => !t.checked));
            }

            async function exportData() {
                const data = await db.exportData();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `checklist-backup-${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            async function importData() {
                fileInputRef.current?.click();
            }

            async function handleFileImport(event) {
                const file = event.target.files?.[0];
                if (!file) return;
                
                const text = await file.text();
                const success = await db.importData(text);
                if (success) {
                    await loadAllData();
                    alert("Îç∞Ïù¥ÌÑ∞Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§!");
                } else {
                    alert("ÌååÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.");
                }
                event.target.value = '';
            }

            function startEditCategory(catId) {
                const cat = categories.find(c => c.id === catId);
                if (!cat || cat.builtin) return;
                setEditingCatId(catId);
                setEditCatName(cat.name);
                setEditCatEmoji(cat.emoji || "üìÅ");
            }

            function saveEditCategory() {
                if (!editCatName.trim()) return;
                renameCategory(editingCatId, editCatName.trim(), editCatEmoji);
                setEditingCatId(null);
                setEditCatName("");
                setEditCatEmoji("");
            }

            function cancelEditCategory() {
                setEditingCatId(null);
                setEditCatName("");
                setEditCatEmoji("");
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 text-gray-900">
                    {/* Sidebar */}
                    <aside className="sidebar p-6">
                        <div className="mb-8">
                            <div className="flex items-center gap-3 mb-4">
                                <div className="w-10 h-10 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                                    <span className="text-white text-lg font-bold">‚úì</span>
                                </div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-800">TodoMaster</h1>
                                    <p className="text-xs text-gray-500">Ïä§ÎßàÌä∏ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏</p>
                                </div>
                            </div>
                            <div className="glassmorphism rounded-2xl p-4 mb-4">
                                <div className="text-sm text-gray-600 mb-2">Ï†ÑÏ≤¥ ÏßÑÌñâÎ•†</div>
                                <div className="text-2xl font-bold text-gray-800 mb-2">
                                    {stats.completed}/{stats.total}
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                                    <div
                                        className="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500 progress-glow"
                                        style={{ width: `${stats.progress}%` }}
                                    ></div>
                                </div>
                                <div className="text-xs text-gray-500">{stats.progress}% ÏôÑÎ£å</div>
                            </div>
                        </div>

                        <div className="mb-6">
                            <div className="font-semibold mb-3 text-gray-700">üìÇ Ïπ¥ÌÖåÍ≥†Î¶¨</div>
                            <div className="space-y-2">
                                {categories.map((c) => (
                                    <div
                                        key={c.id}
                                        className={cn(
                                            "flex items-center gap-3 px-4 py-3 rounded-2xl cursor-pointer transition-all duration-300 card-hover",
                                            selectedCat === c.id 
                                                ? "category-active text-white shadow-lg" 
                                                : "glassmorphism hover:shadow-md"
                                        )}
                                    >
                                        {editingCatId === c.id ? (
                                            <div className="flex-1 space-y-2">
                                                <div className="flex gap-2">
                                                    <input
                                                        value={editCatEmoji}
                                                        onChange={(e) => setEditCatEmoji(e.target.value)}
                                                        placeholder="üè∑Ô∏è"
                                                        className="w-12 px-2 py-1 border rounded text-center"
                                                        maxLength={2}
                                                    />
                                                    <input
                                                        value={editCatName}
                                                        onChange={(e) => setEditCatName(e.target.value)}
                                                        placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ"
                                                        className="flex-1 px-2 py-1 border rounded"
                                                        autoFocus
                                                        onKeyDown={(e) => {
                                                            if (e.key === "Enter") saveEditCategory();
                                                            if (e.key === "Escape") cancelEditCategory();
                                                        }}
                                                    />
                                                </div>
                                                <div className="flex gap-1">
                                                    <button
                                                        onClick={saveEditCategory}
                                                        className="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                                                    >
                                                        Ï†ÄÏû•
                                                    </button>
                                                    <button
                                                        onClick={cancelEditCategory}
                                                        className="px-2 py-1 text-xs border rounded hover:bg-gray-50"
                                                    >
                                                        Ï∑®ÏÜå
                                                    </button>
                                                </div>
                                            </div>
                                        ) : (
                                            <>
                                                <span 
                                                    className="text-lg w-6 text-center"
                                                    onClick={() => setSelectedCat(c.id)}
                                                >
                                                    {c.emoji || "üìÅ"}
                                                </span>
                                                <div 
                                                    className="flex-1 font-medium"
                                                    onClick={() => setSelectedCat(c.id)}
                                                >
                                                    {c.name}
                                                </div>
                                                {!c.builtin && (
                                                    <div className="flex items-center gap-1">
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                startEditCategory(c.id);
                                                            }}
                                                            className="text-gray-400 hover:text-blue-600"
                                                            title="ÏàòÏ†ï"
                                                        >
                                                            ‚úé
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                deleteCategory(c.id);
                                                            }}
                                                            className="text-gray-400 hover:text-red-600"
                                                            title="ÏÇ≠Ï†ú"
                                                        >
                                                            ‚úï
                                                        </button>
                                                    </div>
                                                )}
                                            </>
                                        )}
                                    </div>
                                ))}
                            </div>
                            
                            <div className="mt-6 bg-white/60 backdrop-blur-sm rounded-2xl p-4 border border-gray-200/50">
                                <div className="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                                    <span>‚ûï</span>
                                    ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä
                                </div>
                                <div className="space-y-3">
                                    <input
                                        value={newCatName}
                                        onChange={(e) => setNewCatName(e.target.value)}
                                        onKeyDown={(e) => e.key === "Enter" && addCategory()}
                                        placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white text-gray-800 placeholder-gray-500"
                                    />
                                    <button
                                        onClick={addCategory}
                                        disabled={!newCatName.trim()}
                                        className="w-full px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed transform hover:scale-[1.02] transition-all duration-200 shadow-md font-medium flex items-center justify-center gap-2"
                                    >
                                        <span>‚ú®</span>
                                        Ï∂îÍ∞ÄÌïòÍ∏∞
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <button
                                onClick={() => setSettingsOpen(true)}
                                className="w-full px-4 py-2 text-left rounded-xl hover:bg-gray-100 flex items-center gap-2"
                            >
                                ‚öôÔ∏è ÏÑ§Ï†ï
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="main-content p-6">
                        <div className="max-w-5xl mx-auto">
                            {/* Header */}
                            <div className="mb-8">
                                <div className="glassmorphism rounded-3xl p-6 mb-6">
                                    <div className="flex items-center justify-between mb-4">
                                        <div className="flex items-center gap-4">
                                            <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                                                <span className="text-white text-xl">
                                                    {categories.find(c => c.id === selectedCat)?.emoji || "üìã"}
                                                </span>
                                            </div>
                                            <div>
                                                <h2 className="text-3xl font-bold text-gray-800">
                                                    {categories.find(c => c.id === selectedCat)?.name || "Ï†ÑÏ≤¥"}
                                                </h2>
                                                <p className="text-gray-500">
                                                    {filteredTasks.length}Í∞úÏùò ÏûëÏóÖÏù¥ ÏûàÏäµÎãàÎã§
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex gap-3">
                                            {selectedCat !== "all" && (
                                                <button
                                                    onClick={addTask}
                                                    className="px-6 py-3 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-600 text-white hover:from-emerald-600 hover:to-teal-700 transform hover:scale-105 transition-all duration-200 shadow-lg font-medium flex items-center gap-2"
                                                >
                                                    <span className="text-lg">‚ú®</span>
                                                    ÏûëÏóÖ Ï∂îÍ∞Ä
                                                </button>
                                            )}
                                            {filteredTasks.some(t => t.checked) && (
                                                <button
                                                    onClick={clearCompleted}
                                                    className="px-4 py-3 rounded-2xl glassmorphism hover:shadow-md transition-all duration-200 text-gray-700 font-medium"
                                                >
                                                    üóëÔ∏è ÏôÑÎ£å ÏÇ≠Ï†ú
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    {/* Progress Bar */}
                                    <div className="w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden">
                                        <div
                                            className="bg-gradient-to-r from-emerald-500 to-teal-600 h-4 rounded-full transition-all duration-700 progress-glow relative"
                                            style={{ width: `${stats.progress}%` }}
                                        >
                                            <div className="absolute inset-0 bg-white/20 animate-pulse"></div>
                                        </div>
                                    </div>
                                </div>

                                {/* Filters */}
                                <div className="glassmorphism rounded-2xl p-4 mb-6">
                                    <div className="flex flex-wrap gap-3">
                                        <div className="flex-1 min-w-64">
                                            <input
                                                value={query}
                                                onChange={(e) => setQuery(e.target.value)}
                                                placeholder="üîç ÏûëÏóÖ Í≤ÄÏÉâ..."
                                                className="w-full px-4 py-3 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/70 backdrop-blur-sm font-medium"
                                            />
                                        </div>
                                        <select
                                            value={statusFilter}
                                            onChange={(e) => setStatusFilter(e.target.value)}
                                            className="px-4 py-3 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/70 backdrop-blur-sm font-medium"
                                        >
                                            <option value="all">üìã Î™®Îì† ÏÉÅÌÉú</option>
                                            <option value="pending">‚è≥ ÎØ∏ÏôÑÎ£å</option>
                                            <option value="completed">‚úÖ ÏôÑÎ£å</option>
                                        </select>
                                        <select
                                            value={prioFilter}
                                            onChange={(e) => setPrioFilter(e.target.value)}
                                            className="px-4 py-3 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/70 backdrop-blur-sm font-medium"
                                        >
                                            <option value="all">üéØ Î™®Îì† Ïö∞ÏÑ†ÏàúÏúÑ</option>
                                            {PRIORITIES.map(p => (
                                                <option key={p.value} value={p.value}>
                                                    {p.value === 'high' ? 'üî¥' : p.value === 'medium' ? 'üü°' : p.value === 'low' ? 'üîµ' : '‚ö™'} {p.label}
                                                </option>
                                            ))}
                                        </select>
                                        <select
                                            value={sortBy}
                                            onChange={(e) => setSortBy(e.target.value)}
                                            className="px-4 py-3 border-0 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white/70 backdrop-blur-sm font-medium"
                                        >
                                            <option value="order">üìÖ Îì±Î°ùÏàú</option>
                                            <option value="priority">‚≠ê Ïö∞ÏÑ†ÏàúÏúÑ</option>
                                            <option value="due">‚è∞ ÎßàÍ∞êÏùº</option>
                                            <option value="name">üî§ Ïù¥Î¶Ñ</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            {/* Tasks */}
                            <div className="space-y-3">
                                {filteredTasks.map((task) => (
                                    <TaskCard
                                        key={task.id}
                                        task={task}
                                        categories={categories}
                                        onUpdate={updateTask}
                                        onDelete={deleteTask}
                                        onToggle={toggleTask}
                                        onTogglePin={togglePinTask}
                                    />
                                ))}
                                {filteredTasks.length === 0 && (
                                    <div className="text-center py-12 text-gray-500">
                                        {selectedCat === "all" 
                                            ? "ÏûëÏóÖÏù¥ ÏóÜÏäµÎãàÎã§." 
                                            : "Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê ÏûëÏóÖÏù¥ ÏóÜÏäµÎãàÎã§."}
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>

                    {/* Settings Modal */}
                    {settingsOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-md m-4">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold">ÏÑ§Ï†ï</h3>
                                    <button
                                        onClick={() => setSettingsOpen(false)}
                                        className="text-gray-400 hover:text-gray-600"
                                    >
                                        ‚úï
                                    </button>
                                </div>

                                <div className="space-y-6">
                                    {/* Sound Settings */}
                                    <section>
                                        <h4 className="font-semibold mb-2">ÏÇ¨Ïö¥Îìú</h4>
                                        <div className="flex items-center gap-3">
                                            <label className="inline-flex items-center gap-2 text-sm">
                                                <input
                                                    type="checkbox"
                                                    checked={soundOn}
                                                    onChange={(e) => setSoundOn(e.target.checked)}
                                                />
                                                Ï≤¥ÌÅ¨/Ìï¥Ï†ú Ïãú Ìö®Í≥ºÏùå Ïû¨ÏÉù
                                            </label>
                                            <button
                                                onClick={() => {
                                                    if (soundOn) playSuccess();
                                                }}
                                                className="px-3 py-2 rounded-xl border hover:bg-gray-50 text-sm"
                                            >
                                                ÌÖåÏä§Ìä∏
                                            </button>
                                        </div>
                                    </section>

                                    {/* Data Backup */}
                                    <section>
                                        <h4 className="font-semibold mb-2">Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ</h4>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={exportData}
                                                className="flex-1 px-4 py-2 rounded-xl border hover:bg-gray-50"
                                            >
                                                ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                                            </button>
                                            <button
                                                onClick={importData}
                                                className="flex-1 px-4 py-2 rounded-xl border hover:bg-gray-50"
                                            >
                                                Í∞ÄÏ†∏Ïò§Í∏∞
                                            </button>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-2">
                                            JSON ÌååÏùºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º Î∞±ÏóÖÌïòÍ±∞ÎÇò Î≥µÏõêÌï† Ïàò ÏûàÏäµÎãàÎã§.
                                        </p>
                                    </section>
                                </div>
                            </div>
                        </div>
                    )}

                    <input
                        ref={fileInputRef}
                        type="file"
                        accept=".json"
                        onChange={handleFileImport}
                        style={{ display: 'none' }}
                    />
                </div>
            );
        }

        // Task Card Component with performance optimization
        const TaskCard = React.memo(function TaskCard({ task, categories, onUpdate, onDelete, onToggle, onTogglePin }) {
            const [editing, setEditing] = useState(false);
            const [title, setTitle] = useState(task.title);
            const [memo, setMemo] = useState(task.memo || "");
            const [priority, setPriority] = useState(task.priority);
            const [due, setDue] = useState(task.due || "");
            const [categoryId, setCategoryId] = useState(task.categoryId);

            const handleSave = () => {
                onUpdate(task.id, {
                    title: title.trim() || "Î¨¥Ï†ú",
                    memo: memo.trim(),
                    priority,
                    due,
                    categoryId,
                });
                setEditing(false);
            };

            const handleCancel = () => {
                setTitle(task.title);
                setMemo(task.memo || "");
                setPriority(task.priority);
                setDue(task.due || "");
                setCategoryId(task.categoryId);
                setEditing(false);
            };

            const priorityColor = PRIORITIES.find(p => p.value === task.priority)?.color || "gray";
            const isOverdue = task.due && new Date(task.due) < new Date() && !task.checked;

            const handleDoubleClick = () => {
                if (!editing) setEditing(true);
            };

            return (
                <div
                    className={cn(
                        "glassmorphism rounded-2xl p-6 transition-all duration-300 card-hover relative",
                        task.checked && "opacity-70 grayscale",
                        isOverdue && "ring-2 ring-red-300 bg-red-50/50",
                        task.pinned && "ring-2 ring-yellow-400 bg-yellow-50/30",
                        !task.checked && "hover:shadow-lg"
                    )}
                    data-task-id={task.id}
                    onDoubleClick={handleDoubleClick}
                >
                    {task.pinned && (
                        <div className="absolute -top-2 -right-2 w-6 h-6 bg-yellow-400 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg">
                            üìå
                        </div>
                    )}
                    {editing ? (
                        <div className="space-y-3">
                            <input
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                className="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="ÏûëÏóÖ Ï†úÎ™©"
                            />
                            <textarea
                                value={memo}
                                onChange={(e) => setMemo(e.target.value)}
                                className="w-full px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Î©îÎ™® (ÏÑ†ÌÉùÏÇ¨Ìï≠)"
                                rows={2}
                            />
                            <div className="flex gap-2">
                                <select
                                    value={priority}
                                    onChange={(e) => setPriority(e.target.value)}
                                    className="px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    {PRIORITIES.map(p => (
                                        <option key={p.value} value={p.value}>{p.label}</option>
                                    ))}
                                </select>
                                <input
                                    type="date"
                                    value={due}
                                    onChange={(e) => setDue(e.target.value)}
                                    className="px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                                <select
                                    value={categoryId}
                                    onChange={(e) => setCategoryId(e.target.value)}
                                    className="px-3 py-2 border rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    {categories.filter(c => c.id !== "all").map(c => (
                                        <option key={c.id} value={c.id}>{c.emoji} {c.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={handleSave}
                                    className="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700"
                                >
                                    Ï†ÄÏû•
                                </button>
                                <button
                                    onClick={handleCancel}
                                    className="px-4 py-2 rounded-xl border hover:bg-gray-50"
                                >
                                    Ï∑®ÏÜå
                                </button>
                            </div>
                        </div>
                    ) : (
                        <div className="flex items-start gap-4">
                            <button
                                onClick={() => onToggle(task.id)}
                                className={cn(
                                    "mt-1 w-7 h-7 rounded-xl border-2 flex items-center justify-center transition-all duration-300 font-bold",
                                    task.checked
                                        ? "bg-gradient-to-r from-emerald-500 to-teal-600 border-emerald-500 text-white shadow-lg transform scale-110"
                                        : "border-gray-300 hover:border-blue-500 hover:bg-blue-50 hover:scale-105"
                                )}
                            >
                                {task.checked && "‚úì"}
                            </button>
                            
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-3 mb-2">
                                    <h4
                                        className={cn(
                                            "font-semibold text-lg",
                                            task.checked && "line-through text-gray-500"
                                        )}
                                    >
                                        {task.title}
                                    </h4>
                                    {task.priority !== "none" && (
                                        <span
                                            className={cn(
                                                "px-3 py-1 text-xs font-medium rounded-full",
                                                priorityColor === "red" && "bg-gradient-to-r from-red-100 to-red-200 text-red-700 border border-red-300",
                                                priorityColor === "yellow" && "bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-700 border border-yellow-300",
                                                priorityColor === "blue" && "bg-gradient-to-r from-blue-100 to-blue-200 text-blue-700 border border-blue-300"
                                            )}
                                        >
                                            {task.priority === 'high' ? 'üî¥' : task.priority === 'medium' ? 'üü°' : task.priority === 'low' ? 'üîµ' : '‚ö™'} {PRIORITIES.find(p => p.value === task.priority)?.label}
                                        </span>
                                    )}
                                </div>
                                
                                {task.memo && (
                                    <p className="text-gray-600 mb-3 leading-relaxed">{task.memo}</p>
                                )}
                                
                                <div className="flex items-center gap-4 text-sm text-gray-500">
                                    {task.due && (
                                        <span className={cn(
                                            "flex items-center gap-1 px-2 py-1 rounded-lg",
                                            isOverdue ? "text-red-600 font-medium bg-red-50" : "bg-gray-100"
                                        )}>
                                            üìÖ {fmtDate(task.due)}
                                            {isOverdue && " ‚ö†Ô∏è"}
                                        </span>
                                    )}
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-1">
                                <button
                                    onClick={() => onTogglePin(task.id)}
                                    className={cn(
                                        "p-2 rounded-xl transition-all duration-200",
                                        task.pinned 
                                            ? "text-yellow-600 hover:text-yellow-700 bg-yellow-50 hover:bg-yellow-100" 
                                            : "text-gray-400 hover:text-yellow-600 hover:bg-yellow-50"
                                    )}
                                    title={task.pinned ? "Í≥†Ï†ï Ìï¥Ï†ú" : "ÏÉÅÎã® Í≥†Ï†ï"}
                                >
                                    <span className="text-lg">üìå</span>
                                </button>
                                <button
                                    onClick={() => setEditing(true)}
                                    className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all duration-200"
                                    title="Ìé∏Ïßë (ÎçîÎ∏îÌÅ¥Î¶≠ Í∞ÄÎä•)"
                                >
                                    <span className="text-lg">‚úèÔ∏è</span>
                                </button>
                                <button
                                    onClick={() => onDelete(task.id)}
                                    className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all duration-200"
                                    title="ÏÇ≠Ï†ú"
                                >
                                    <span className="text-lg">üóëÔ∏è</span>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }, (prevProps, nextProps) => {
            // Custom comparison for memo optimization
            return prevProps.task.id === nextProps.task.id &&
                   prevProps.task.title === nextProps.task.title &&
                   prevProps.task.checked === nextProps.task.checked &&
                   prevProps.task.priority === nextProps.task.priority &&
                   prevProps.task.due === nextProps.task.due &&
                   prevProps.task.memo === nextProps.task.memo &&
                   prevProps.task.pinned === nextProps.task.pinned &&
                   prevProps.task.categoryId === nextProps.task.categoryId;
        });

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
