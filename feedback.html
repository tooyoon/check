<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”¼ë“œë°± - CheckMaster</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js?v=4.0"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’¬</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .back-link {
            display: inline-block;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }
        
        .feedback-form {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .category-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .category-btn {
            padding: 8px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        
        .category-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .feedback-list {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .feedback-count {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feedback-item {
            border-bottom: 1px solid #e1e8ed;
            padding: 20px 0;
        }
        
        .feedback-item:last-child {
            border-bottom: none;
        }
        
        .feedback-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .feedback-category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .category-bug { background: #fee; color: #c00; }
        .category-feature { background: #e6f7ff; color: #0050b3; }
        .category-improvement { background: #f6ffed; color: #389e0d; }
        .category-other { background: #f0f0f0; color: #666; }
        
        .feedback-content {
            margin: 15px 0;
            color: #333;
            line-height: 1.6;
        }
        
        .feedback-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #999;
        }
        
        .vote-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .vote-btn {
            padding: 5px 12px;
            border: 1px solid #e1e8ed;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .vote-btn:hover {
            background: #f8f9fa;
        }
        
        .vote-btn.voted {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.show {
            display: block;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .filter-tab {
            padding: 8px 20px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-tab:hover {
            background: #e0e0e0;
        }
        
        .filter-tab.active {
            background: #667eea;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .feedback-form,
            .feedback-list {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .feedback-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/index.html" class="back-link">â† ëŒì•„ê°€ê¸°</a>
        
        <div class="header">
            <h1>
                ğŸ’¬ í”¼ë“œë°± ê²Œì‹œíŒ
                <span style="font-size: 0.5em; opacity: 0.8;">Beta</span>
            </h1>
            <p>CheckMasterë¥¼ ë” ì¢‹ê²Œ ë§Œë“¤ì–´ì£¼ì„¸ìš”! ê±´ì˜ì‚¬í•­, ë²„ê·¸, ì•„ì´ë””ì–´ë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”.</p>
            <div id="authStatus" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.8); border-radius: 8px; font-size: 14px;">
                <!-- Auth status will be shown here -->
            </div>
        </div>
        
        <div class="feedback-form">
            <h2 style="margin-bottom: 20px;">âœ¨ ì˜ê²¬ ë‚¨ê¸°ê¸°</h2>
            <div id="message" class="message"></div>
            
            <form id="feedbackForm">
                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <div class="category-buttons">
                        <button type="button" class="category-btn" data-category="bug">ğŸ› ë²„ê·¸</button>
                        <button type="button" class="category-btn" data-category="feature">âœ¨ ê¸°ëŠ¥ ìš”ì²­</button>
                        <button type="button" class="category-btn" data-category="improvement">ğŸ’¡ ê°œì„  ì‚¬í•­</button>
                        <button type="button" class="category-btn" data-category="other">ğŸ“ ê¸°íƒ€</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="title">ì œëª© <span style="color: red;">*</span></label>
                    <input type="text" id="title" required placeholder="ê°„ë‹¨í•œ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label for="content">ë‚´ìš© <span style="color: red;">*</span></label>
                    <textarea id="content" required placeholder="ìì„¸í•œ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”. ë²„ê·¸ì˜ ê²½ìš° ì¬í˜„ ë°©ë²•ì„ ì•Œë ¤ì£¼ì‹œë©´ ë„ì›€ì´ ë©ë‹ˆë‹¤."></textarea>
                </div>
                
                
                <button type="submit" class="submit-btn">í”¼ë“œë°± ì œì¶œ</button>
            </form>
        </div>
        
        <div class="feedback-list">
            <h2 style="margin-bottom: 20px;">ğŸ“‹ ì»¤ë®¤ë‹ˆí‹° í”¼ë“œë°±</h2>
            
            <!-- Search Bar -->
            <div style="margin-bottom: 20px;">
                <input type="text" 
                       id="searchInput" 
                       placeholder="ğŸ” í”¼ë“œë°± ê²€ìƒ‰..." 
                       style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; background: white;"
                       onkeyup="searchFeedbacks()">
            </div>
            
            <div class="feedback-count">
                <div>
                    <strong id="totalCount">0</strong>ê°œì˜ í”¼ë“œë°±
                </div>
                <div style="font-size: 14px;">
                    ğŸ› ë²„ê·¸: <span id="bugCount">0</span> | 
                    âœ¨ ê¸°ëŠ¥: <span id="featureCount">0</span> | 
                    ğŸ’¡ ê°œì„ : <span id="improvementCount">0</span>
                </div>
            </div>
            
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">ì „ì²´</button>
                <button class="filter-tab" data-filter="bug">ë²„ê·¸</button>
                <button class="filter-tab" data-filter="feature">ê¸°ëŠ¥ ìš”ì²­</button>
                <button class="filter-tab" data-filter="improvement">ê°œì„  ì‚¬í•­</button>
                <button class="filter-tab" data-filter="other">ê¸°íƒ€</button>
            </div>
            
            <div id="feedbackList">
                <div class="empty-state">
                    <h3>ì•„ì§ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>ì²« ë²ˆì§¸ í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Initialize
        let selectedCategory = null;
        let currentFilter = 'all';
        let feedbacks = [];
        let userVotes = JSON.parse(localStorage.getItem('feedbackVotes') || '{}');
        
        // Category selection
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedCategory = btn.dataset.category;
            });
        });
        
        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                displayFeedbacks();
            });
        });
        
        // Form submission
        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!selectedCategory) {
                showMessage('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // Check if user is logged in
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                showMessage('í”¼ë“œë°±ì„ ì‘ì„±í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            
            // Get user info
            const userName = user.email?.split('@')[0] || 'ì‚¬ìš©ì';
            const userEmail = user.email;
            
            // Save to Supabase
            const { error } = await supabase
                .from('feedback')
                .insert([
                    {
                        category: selectedCategory,
                        title: title,
                        content: content,
                        name: userName,
                        email: userEmail,
                        user_id: user.id,
                        votes: 0,
                        status: 'pending'
                    }
                ]);
            
            if (error) {
                console.error('Feedback submission error:', error);
                // Save locally if Supabase fails
                const localFeedbacks = JSON.parse(localStorage.getItem('localFeedbacks') || '[]');
                localFeedbacks.push({
                    id: Date.now(),
                    category: selectedCategory,
                    title: title,
                    content: content,
                    name: userName,
                    email: userEmail,
                    created_at: new Date().toISOString(),
                    votes: 0
                });
                localStorage.setItem('localFeedbacks', JSON.stringify(localFeedbacks));
            }
            
            showMessage('í”¼ë“œë°±ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!', 'success');
            
            // Reset form
            document.getElementById('feedbackForm').reset();
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            selectedCategory = null;
            
            // Reload feedbacks
            loadFeedbacks();
        });
        
        // Load feedbacks
        async function loadFeedbacks() {
            try {
                const { data, error } = await supabase
                    .from('feedback')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                feedbacks = data || [];
            } catch (error) {
                console.error('Failed to load feedbacks:', error);
                // Load from local storage
                feedbacks = JSON.parse(localStorage.getItem('localFeedbacks') || '[]');
            }
            
            displayFeedbacks();
        }
        
        // Update statistics
        function updateStats() {
            const total = feedbacks.length;
            const bugs = feedbacks.filter(f => f.category === 'bug').length;
            const features = feedbacks.filter(f => f.category === 'feature').length;
            const improvements = feedbacks.filter(f => f.category === 'improvement').length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('bugCount').textContent = bugs;
            document.getElementById('featureCount').textContent = features;
            document.getElementById('improvementCount').textContent = improvements;
        }
        
        // Search feedbacks
        let searchQuery = '';
        
        function searchFeedbacks() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase();
            displayFeedbacks();
        }
        
        // Highlight feedback
        function highlightFeedback(id) {
            // Remove previous highlights
            document.querySelectorAll('.feedback-item').forEach(item => {
                item.style.background = '';
                item.style.boxShadow = '';
                item.style.transform = '';
            });
            
            // Add highlight to clicked item
            const element = document.getElementById(`feedback-${id}`);
            if (element) {
                element.style.background = 'linear-gradient(135deg, #667eea15 0%, #764ba215 100%)';
                element.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.3)';
                element.style.transform = 'scale(1.02)';
                
                // Scroll to element
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        // Display feedbacks
        function displayFeedbacks() {
            updateStats();
            const container = document.getElementById('feedbackList');
            let filtered = currentFilter === 'all' 
                ? feedbacks 
                : feedbacks.filter(f => f.category === currentFilter);
            
            // Apply search filter
            if (searchQuery) {
                filtered = filtered.filter(f => 
                    f.title.toLowerCase().includes(searchQuery) || 
                    f.content.toLowerCase().includes(searchQuery) ||
                    (f.name && f.name.toLowerCase().includes(searchQuery)) ||
                    (f.email && f.email.toLowerCase().includes(searchQuery))
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>${currentFilter === 'all' ? 'ì²« ë²ˆì§¸ í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”!' : 'ì´ ì¹´í…Œê³ ë¦¬ì—ëŠ” ì•„ì§ í”¼ë“œë°±ì´ ì—†ìŠµë‹ˆë‹¤.'}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(feedback => `
                <div class="feedback-item" id="feedback-${feedback.id}" onclick="highlightFeedback('${feedback.id}')" style="cursor: pointer; transition: all 0.3s ease;">
                    <div class="feedback-header">
                        <div>
                            <span class="feedback-category category-${feedback.category}">
                                ${getCategoryLabel(feedback.category)}
                            </span>
                            ${feedback.status === 'resolved' ? '<span style="color: green; margin-left: 10px;">âœ“ í•´ê²°ë¨</span>' : ''}
                        </div>
                        <div class="vote-buttons">
                            <button class="vote-btn ${userVotes[feedback.id] ? 'voted' : ''}" 
                                    onclick="event.stopPropagation(); toggleVote('${feedback.id}')">
                                ğŸ‘ ${feedback.votes || 0}
                            </button>
                        </div>
                    </div>
                    <h3 style="margin-top: 10px;">${escapeHtml(feedback.title)}</h3>
                    <div class="feedback-content">
                        ${escapeHtml(feedback.content).replace(/\n/g, '<br>')}
                    </div>
                    <div class="feedback-meta">
                        <span>ğŸ‘¤ ${feedback.name ? escapeHtml(feedback.name) : (feedback.email ? escapeHtml(feedback.email.split('@')[0]) : 'ìµëª…')}</span>
                        <span>${formatDate(feedback.created_at)}</span>
                        ${feedback.email ? '<span>âœ‰ï¸ ë‹µë³€ ìš”ì²­</span>' : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Vote toggle
        async function toggleVote(feedbackId) {
            // Check if user is logged in
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                showMessage('íˆ¬í‘œí•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            const voteKey = `${user.id}_${feedbackId}`;
            const hasVoted = userVotes[voteKey];
            const feedback = feedbacks.find(f => f.id === feedbackId);
            if (!feedback) return;
            
            try {
                if (hasVoted) {
                    delete userVotes[voteKey];
                    feedback.votes = Math.max(0, (feedback.votes || 0) - 1);
                } else {
                    userVotes[voteKey] = true;
                    feedback.votes = (feedback.votes || 0) + 1;
                }
                
                localStorage.setItem('feedbackVotes', JSON.stringify(userVotes));
                
                // Update in Supabase
                const { error } = await supabase
                    .from('feedback')
                    .update({ votes: feedback.votes })
                    .eq('id', feedbackId);
                    
                if (error) throw error;
                
                displayFeedbacks(); // Refresh display
            } catch (error) {
                console.error('Failed to update vote:', error);
                // Revert on error
                if (hasVoted) {
                    userVotes[voteKey] = true;
                    feedback.votes = (feedback.votes || 0) + 1;
                } else {
                    delete userVotes[voteKey];
                    feedback.votes = Math.max(0, (feedback.votes || 0) - 1);
                }
                localStorage.setItem('feedbackVotes', JSON.stringify(userVotes));
            }
            
            displayFeedbacks();
        }
        
        // Helper functions
        function getCategoryLabel(category) {
            const labels = {
                bug: 'ğŸ› ë²„ê·¸',
                feature: 'âœ¨ ê¸°ëŠ¥ ìš”ì²­',
                improvement: 'ğŸ’¡ ê°œì„  ì‚¬í•­',
                other: 'ğŸ“ ê¸°íƒ€'
            };
            return labels[category] || category;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                if (hours === 0) {
                    const minutes = Math.floor(diff / (1000 * 60));
                    return minutes === 0 ? 'ë°©ê¸ˆ ì „' : `${minutes}ë¶„ ì „`;
                }
                return `${hours}ì‹œê°„ ì „`;
            } else if (days === 1) {
                return 'ì–´ì œ';
            } else if (days < 30) {
                return `${days}ì¼ ì „`;
            } else {
                return date.toLocaleDateString('ko-KR');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} show`;
            
            setTimeout(() => {
                messageEl.className = 'message';
            }, 3000);
        }
        
        // Update auth status display
        async function updateAuthStatus() {
            const authDiv = document.getElementById('authStatus');
            // Check if user is logged in
            const { data: { user } } = await supabase.auth.getUser();
            
            if (user) {
                authDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ‘¤ ë¡œê·¸ì¸ë¨: <strong>${user.email}</strong></span>
                        <button onclick="supabase.auth.signOut(); location.reload();" 
                                style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                `;
            } else {
                authDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>âš ï¸ í”¼ë“œë°±ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</span>
                        <button onclick="supabase.auth.signInWithOAuth({ provider: 'google' });" 
                                style="padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Google ë¡œê·¸ì¸
                        </button>
                    </div>
                `;
            }
        }
        
        // Load on page load
        loadFeedbacks();
        updateAuthStatus();
        
        // Auto refresh every 30 seconds
        setInterval(loadFeedbacks, 30000);
    </script>
</body>
</html>